import json
import pathlib
import os
import requests # Si prefieres usar requests en lugar de curl

def generate_and_send():
    repo = os.environ.get("REPO")
    branch = os.environ.get("BRANCH")
    run_url = os.environ.get("RUN_URL")
    webhook_url = os.environ.get("PORT_WEBHOOK_URL")

    # Ajustamos la ruta: asumiendo que el script se corre desde la raíz del nuevo repo clonado
    openapi_path = pathlib.Path("api/openapi.yaml")
    open_api = openapi_path.read_text(encoding="utf-8") if openapi_path.exists() else ""

    payload = {
        "microservicio": {
            "cod_servicio": repo,
            "nombre_servicio": repo,
            "open_api": open_api,
            "tecnologia": "Java",
            "estado_de_aprovisionamiento": "Generado"
        },
        "branch": {
            "codigo_branch": f"{repo}:{branch}",
            "build_status": "Con errores",
            "cobertura": 0,
            "vulnerabilidades_altas": 0,
            "secretos_encontrados": 0,
            "url_pipeline": run_url
        }
    }

    # Enviar a Port directamente desde Python
    response = requests.post(webhook_url, json=payload)
    response.raise_for_status()
    print(f"Notificación enviada a Port con éxito: {response.status_code}")

if __name__ == "__main__":
    generate_and_send()